#!/usr/bin/env bash
#
# Pre-push hook: Validate diagrams and check for out-of-date indexes
# This hook ensures all diagrams are rendered before pushing
#

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üöÄ Running pre-push checks...${NC}"

# Get the root of the git repository
GIT_ROOT=$(git rev-parse --show-toplevel)
cd "$GIT_ROOT"

ISSUES_FOUND=0

#
# 1. CHECK ALL DIAGRAMS ARE RENDERED
#
echo -e "\n${BLUE}üìä Verifying all diagrams are rendered...${NC}"

# Check .dot files
UNRENDERED_DIAGRAMS=()

while IFS= read -r dotfile; do
    txtfile="${dotfile%.dot}.txt"
    if [ ! -f "$txtfile" ]; then
        UNRENDERED_DIAGRAMS+=("$dotfile ‚Üí $txtfile (missing)")
        ISSUES_FOUND=$((ISSUES_FOUND + 1))
    elif [ "$dotfile" -nt "$txtfile" ]; then
        UNRENDERED_DIAGRAMS+=("$dotfile ‚Üí $txtfile (outdated)")
        ISSUES_FOUND=$((ISSUES_FOUND + 1))
    fi
done < <(find . -name "*.dot" -type f 2>/dev/null)

# Check .puml files
while IFS= read -r pumlfile; do
    utxtfile="${pumlfile%.puml}.utxt"
    if [ ! -f "$utxtfile" ]; then
        UNRENDERED_DIAGRAMS+=("$pumlfile ‚Üí $utxtfile (missing)")
        ISSUES_FOUND=$((ISSUES_FOUND + 1))
    elif [ "$pumlfile" -nt "$utxtfile" ]; then
        UNRENDERED_DIAGRAMS+=("$pumlfile ‚Üí $utxtfile (outdated)")
        ISSUES_FOUND=$((ISSUES_FOUND + 1))
    fi
done < <(find . -name "*.puml" -type f 2>/dev/null)

# Check .d2 files
while IFS= read -r d2file; do
    svgfile="${d2file%.d2}.svg"
    if [ ! -f "$svgfile" ]; then
        UNRENDERED_DIAGRAMS+=("$d2file ‚Üí $svgfile (missing)")
        ISSUES_FOUND=$((ISSUES_FOUND + 1))
    elif [ "$d2file" -nt "$svgfile" ]; then
        UNRENDERED_DIAGRAMS+=("$d2file ‚Üí $svgfile (outdated)")
        ISSUES_FOUND=$((ISSUES_FOUND + 1))
    fi
done < <(find . -name "*.d2" -type f 2>/dev/null)

if [ ${#UNRENDERED_DIAGRAMS[@]} -gt 0 ]; then
    echo -e "${YELLOW}  ‚ö†Ô∏è  Found ${#UNRENDERED_DIAGRAMS[@]} diagram(s) that need rendering:${NC}"
    for diagram in "${UNRENDERED_DIAGRAMS[@]}"; do
        echo -e "${YELLOW}     ‚Ä¢ $diagram${NC}"
    done
    echo -e "${YELLOW}  üí° Commit the source files to auto-render them${NC}"
else
    echo -e "${GREEN}  ‚úì All diagrams are up to date${NC}"
fi

#
# 2. CHECK VIDEO_INDEX.md (if it exists)
#
if [ -f "VIDEO_INDEX.md" ]; then
    echo -e "\n${BLUE}üìπ Checking VIDEO_INDEX.md freshness...${NC}"

    # Check if VIDEO_INDEX.md is older than any presentation.md files
    OUTDATED_INDEX=0

    while IFS= read -r presfile; do
        if [ "$presfile" -nt "VIDEO_INDEX.md" ]; then
            OUTDATED_INDEX=1
            break
        fi
    done < <(find . -name "presentation.md" -type f 2>/dev/null)

    if [ $OUTDATED_INDEX -eq 1 ]; then
        echo -e "${YELLOW}  ‚ö†Ô∏è  VIDEO_INDEX.md might be out of date${NC}"
        echo -e "${YELLOW}  üí° Consider regenerating it if you added new content${NC}"
    else
        echo -e "${GREEN}  ‚úì VIDEO_INDEX.md appears up to date${NC}"
    fi
fi

#
# 3. OPTIONAL PREFLIGHT CHECKS
#
echo -e "\n${BLUE}üîß Running optional preflight checks...${NC}"

# Check if just is available for running tests
if command -v just &>/dev/null; then
    # Check if there's a test recipe
    if just --list 2>/dev/null | grep -q "test"; then
        echo -e "${BLUE}  ‚Üí Running 'just test'...${NC}"
        if just test; then
            echo -e "${GREEN}    ‚úì Tests passed${NC}"
        else
            echo -e "${YELLOW}    ‚ö†Ô∏è  Tests failed (warning only)${NC}"
        fi
    else
        echo -e "${GREEN}  ‚úì No test recipe defined${NC}"
    fi
else
    echo -e "${YELLOW}  ‚ö†Ô∏è  'just' not installed, skipping recipe checks${NC}"
fi

#
# SUMMARY
#
echo -e "\n${GREEN}‚úÖ Pre-push checks complete!${NC}"

if [ $ISSUES_FOUND -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Found $ISSUES_FOUND issue(s) but allowing push to proceed${NC}"
    echo -e "${YELLOW}üí° Consider addressing the warnings above${NC}"
fi

exit 0
