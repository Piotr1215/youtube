#!/usr/bin/env bash
#
# Pre-commit hook: Auto-render diagrams and run spell check
# This hook automatically renders modified diagram files and stages the outputs
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç Running pre-commit checks...${NC}"

# Track if any files were rendered
FILES_RENDERED=0
DIAGRAMS_RENDERED=()

# Get the root of the git repository
GIT_ROOT=$(git rev-parse --show-toplevel)
cd "$GIT_ROOT"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

#
# 1. AUTO-RENDER DIAGRAMS
#
echo -e "\n${BLUE}üìä Checking for diagram files to render...${NC}"

for file in $STAGED_FILES; do
    # Skip if file doesn't exist (could be deleted)
    [[ ! -f "$file" ]] && continue

    case "$file" in
        *.dot)
            echo -e "${YELLOW}  ‚Üí Rendering: $file${NC}"

            # Render to .txt using graph-easy
            if command -v graph-easy &>/dev/null; then
                output_file="${file%.dot}.txt"
                graph-easy "$file" --as=boxart > "$output_file" 2>&1 || {
                    echo -e "${YELLOW}    ‚ö†Ô∏è  Warning: graph-easy failed for $file${NC}"
                    continue
                }

                # Stage the rendered output
                git add "$output_file"
                echo -e "${GREEN}    ‚úì Generated and staged: $output_file${NC}"
                FILES_RENDERED=$((FILES_RENDERED + 1))
                DIAGRAMS_RENDERED+=("$output_file")
            else
                echo -e "${YELLOW}    ‚ö†Ô∏è  graph-easy not installed, skipping .dot rendering${NC}"
            fi
            ;;

        *.puml)
            echo -e "${YELLOW}  ‚Üí Rendering: $file${NC}"

            # Render to .utxt using plantuml
            if command -v plantuml &>/dev/null || [ -f /usr/local/bin/plantuml.jar ]; then
                output_file="${file%.puml}.utxt"

                # Try plantuml command first, then jar file
                if command -v plantuml &>/dev/null; then
                    plantuml "$file" -utxt 2>&1 || {
                        echo -e "${YELLOW}    ‚ö†Ô∏è  Warning: plantuml failed for $file${NC}"
                        continue
                    }
                elif [ -f /usr/local/bin/plantuml.jar ]; then
                    java -jar /usr/local/bin/plantuml.jar "$file" -utxt 2>&1 || {
                        echo -e "${YELLOW}    ‚ö†Ô∏è  Warning: plantuml failed for $file${NC}"
                        continue
                    }
                fi

                # Stage the rendered output if it exists
                if [ -f "$output_file" ]; then
                    git add "$output_file"
                    echo -e "${GREEN}    ‚úì Generated and staged: $output_file${NC}"
                    FILES_RENDERED=$((FILES_RENDERED + 1))
                    DIAGRAMS_RENDERED+=("$output_file")
                fi
            else
                echo -e "${YELLOW}    ‚ö†Ô∏è  plantuml not installed, skipping .puml rendering${NC}"
            fi
            ;;

        *.d2)
            echo -e "${YELLOW}  ‚Üí Rendering: $file${NC}"

            # Render to .svg using d2
            if command -v d2 &>/dev/null; then
                output_file="${file%.d2}.svg"
                d2 "$file" "$output_file" 2>&1 || {
                    echo -e "${YELLOW}    ‚ö†Ô∏è  Warning: d2 failed for $file${NC}"
                    continue
                }

                # Stage the rendered output
                git add "$output_file"
                echo -e "${GREEN}    ‚úì Generated and staged: $output_file${NC}"
                FILES_RENDERED=$((FILES_RENDERED + 1))
                DIAGRAMS_RENDERED+=("$output_file")
            else
                echo -e "${YELLOW}    ‚ö†Ô∏è  d2 not installed, skipping .d2 rendering${NC}"
            fi
            ;;
    esac
done

if [ $FILES_RENDERED -eq 0 ]; then
    echo -e "${GREEN}  ‚úì No diagrams to render${NC}"
else
    echo -e "\n${GREEN}‚ú® Auto-generated $FILES_RENDERED diagram file(s):${NC}"
    for diagram in "${DIAGRAMS_RENDERED[@]}"; do
        echo -e "${GREEN}   ‚Ä¢ $diagram${NC}"
    done
fi

#
# 2. SPELL CHECK (WARN ONLY)
#
echo -e "\n${BLUE}üìù Running spell check...${NC}"

if command -v typos &>/dev/null; then
    # Run typos on staged files, but don't fail the commit
    if echo "$STAGED_FILES" | xargs -r typos --format brief 2>&1 | grep -v "^$"; then
        echo -e "${YELLOW}  ‚ö†Ô∏è  Typos found (this won't block your commit)${NC}"
        echo -e "${YELLOW}  üí° Run 'typos --write-changes' to fix them${NC}"
    else
        echo -e "${GREEN}  ‚úì No typos detected${NC}"
    fi
else
    echo -e "${YELLOW}  ‚ö†Ô∏è  typos not installed, skipping spell check${NC}"
    echo -e "${YELLOW}  üí° Install with: cargo install typos-cli${NC}"
fi

#
# SUMMARY
#
echo -e "\n${GREEN}‚úÖ Pre-commit checks complete!${NC}"

if [ $FILES_RENDERED -gt 0 ]; then
    echo -e "${BLUE}‚ÑπÔ∏è  Auto-rendered diagrams have been staged for commit${NC}"
fi

exit 0
